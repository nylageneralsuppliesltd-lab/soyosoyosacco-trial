<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>About Us | Soyosoyo SACCO</title>
    <meta name="description" content="From 1998 Medicare roots to modern financial empowerment. The full story of Soyosoyo SACCO.">
    <link rel="stylesheet" href="./style.css?v=40">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .history-section {
            margin: 80px 0;
            padding: 30px;
            background: #f8fdfa;
            border-radius: 24px;
            border: 2px solid #86efac;
            box-shadow: 0 15px 40px rgba(0,0,0,0.08);
            font-family: 'Lato', sans-serif;
        }
        .history-header {
            text-align: center;
            color: #004d1a;
            font-size: 2rem;
            font-weight: 900;
            margin-bottom: 20px;
        }
        .history-controls {
            text-align: center;
            margin: 20px 0;
            gap: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 50px;
            font-weight: 900;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-save {
            background: #10B981;
            color: white;
        }
        .btn-save:hover { 
            background: #059669; 
            transform: translateY(-2px); 
        }
        .btn-download {
            background: #004d1a;
            color: white;
        }
        .btn-download:hover { 
            background: #166534; 
            transform: translateY(-2px); 
        }
        .btn-reload {
            background: #3b82f6;
            color: white;
        }
        .btn-reload:hover { 
            background: #2563eb; 
            transform: translateY(-2px); 
        }
        #fullHistoryTable {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            -webkit-overflow-scrolling: touch;
        }
        #fullHistoryTable table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: white;
            table-layout: fixed;
        }
        #fullHistoryTable th {
            background: #004d1a;
            color: white;
            padding: 16px 8px;
            text-align: center;
            font-weight: 900;
            font-size: 14px;
            white-space: nowrap;
        }
        #fullHistoryTable td {
            padding: 14px 8px;
            text-align: center;
            border-bottom: 1px solid #e6f4ea;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #fullHistoryTable tr:hover {
            background: #fff8e1 !important;
        }
        #fullHistoryTable tr:nth-child(even) {
            background: #f0fdf4;
        }
        /* Right-align numeric columns for clarity */
        #fullHistoryTable td:nth-child(2),
        #fullHistoryTable td:nth-child(3),
        #fullHistoryTable td:nth-child(4),
        #fullHistoryTable td:nth-child(5),
        #fullHistoryTable td:nth-child(6) {
            text-align: right;
        }
        .history-footer {
            text-align: center;
            margin-top: 20px;
            color: #004d1a;
            font-weight: bold;
            font-size: 15px;
        }
        .current-month {
            background: #fff8e1 !important;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(255,193,7,0.3);
        }
        @media (max-width: 768px) {
            .history-section { padding: 20px; margin: 40px 0; }
            .history-header { font-size: 1.5rem; }
            .history-controls { flex-direction: column; align-items: center; }
            .btn { width: 90%; max-width: 300px; }
            #fullHistoryTable table { min-width: 700px; font-size: 12px; }
            #fullHistoryTable th, #fullHistoryTable td { padding: 10px 4px; }
        }
        @media (max-width: 480px) {
            #fullHistoryTable table { min-width: 600px; }
        }
    </style>
</head>
<body>

<header class="site-header">
    <div class="navbar">
        <a href="index.html"><img class="brand-logo round" src="./assets/141dd3faa98da9737b591161deac509a.jpg" alt="Logo"></a>
        <a href="https://chamasoft.com/login" class="member-portal">Member Portal</a>
        <button id="menu-toggle" aria-label="Toggle Menu"></button>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="Products.html">Products</a>
            <a href="Online-Forms.html">Online Forms</a>
            <a href="Jobs.html">Jobs</a>
            <a href="Join-Us.html">Join Us</a>
        </nav>
    </div>
</header>

<main class="container">
    <section class="section">
        <h1 style="text-align: center; margin-bottom: 1.5rem;">The Evolution of Soyosoyo SACCO</h1>
        <p style="text-align: justify; margin: 15px 0;">
            Soyosoyo SACCO boasts a rich history, beginning its journey on <strong>July 15, 1998</strong>, as <strong>SOYOSOYO MEDICARE CO-OPERATIVE SAVINGS & CREDIT SOCIETY</strong>. Its initial, heartwarming mission was to pool funds and provide affordable credit, primarily to help members cover their families' medical bills.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            As the fund grew significantly, the SACCO's vision expanded beyond healthcare. It began to support members in financing their children's education, demonstrating its adaptability and commitment to community needs.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            However, with its membership spreading across various parts of the Kenyan Coast, the complexity of managing the SACCO, combined with the introduction of the National Hospital Insurance Fund (NHIF) which began covering medical bills, led the SACCO into a period of silence.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            But the story didn't end there. In 2022, the dedicated founding members reignited their passion, showing a keen interest in reviving the SACCO. Their goal was clear: to refresh its objectives to align with current community needs.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            This revival culminated in a new beginning for Soyosoyo SACCO. Officially rebranded and given a new look on April 10, 2024, it emerged with renewed vigor. Its expanded mission now focuses on providing affordable financing to cover a broader range of essential objectives, including medical bills, education, agriculture, and development.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            Soyosoyo SACCO stands today as a testament to its enduring commitment to its members, evolving to meet the diverse financial needs of its community.
        </p>
        <div style="text-align: center; margin-top: 2rem;">
            <a href="index.html" class="products-button">Back to Home</a>
        </div>
    </section>

    <!-- MONTHLY HISTORY SECTION — SHARED & ROBUST -->
    <section class="history-section">
        <h2 class="history-header">Monthly Financial History (2025 – Present)</h2>
        <div class="history-controls">
            <button class="btn btn-save" onclick="saveCurrentMonth(true)">SAVE THIS MONTH'S DATA</button>
            <button class="btn btn-download" onclick="downloadHistoryCSV()">DOWNLOAD FULL HISTORY (CSV)</button>
            <button class="btn btn-reload" onclick="reloadHistory()">RELOAD HISTORY</button>
        </div>
        <div id="fullHistoryTable"></div>
        <div class="history-footer" id="historyFooter">Loading shared monthly records...</div>
    </section>
</main>

<footer>
    <p>© 2025–<span id="currentYear"></span> SOYOSOYO SACCO. All rights reserved. | <a href="mailto:info@soyosoyosacco.com">info@soyosoyosacco.com</a></p>
    <div class="social-icons">
        <a href="https://www.facebook.com/people/Soyosoyo-Sacco/61565783836766/" target="_blank"><i class="fab fa-facebook-f"></i></a>
        <a href="https://x.com/SoyosoyoSACCO" target="_blank"><i class="fab fa-x-twitter"></i></a>
        <a href="https://www.instagram.com/soyosoyosacco" target="_blank"><i class="fab fa-instagram"></i></a>
    </div>
</footer>

<script>
  document.getElementById('currentYear').textContent = new Date().getFullYear();
</script>
<script src="./scripts/main.js"></script>
<script src="./scripts/carousel.js"></script>

<script>
    // CONFIG: Replace with your actual API endpoint (e.g., 'https://soyosoyosacco.com/api/history')
    const API_ENDPOINT = 'YOUR_API_ENDPOINT'; // e.g., '/api/history' for relative

    // Load today data (carousel persistence, unchanged)
    function loadTodayData() {
        const savedToday = localStorage.getItem('saccoDataToday');
        if (savedToday && !window.saccoData?.today) {
            try {
                window.saccoData = { today: JSON.parse(savedToday) };
            } catch (e) { console.error('Corrupted today data:', e); }
        }
    }

    // SHARED: Load history from server (primary) or localStorage (fallback)
    async function loadHistoryFromServer() {
        if (!API_ENDPOINT || API_ENDPOINT === 'YOUR_API_ENDPOINT') {
            console.warn('API endpoint not set; falling back to localStorage');
            loadLocalHistory();
            return;
        }
        try {
            const response = await fetch(API_ENDPOINT, { method: 'GET' });
            if (response.ok) {
                window.saccoHistory = await response.json();
                console.log('Loaded shared history from server:', window.saccoHistory);
                // Sync to local for offline fallback
                localStorage.setItem('saccoHistory', JSON.stringify(window.saccoHistory));
            } else {
                throw new Error('Server error');
            }
        } catch (e) {
            console.error('Server load failed:', e);
            loadLocalHistory(); // Fallback
        }
    }

    function loadLocalHistory() {
        const savedHistory = localStorage.getItem('saccoHistory');
        if (savedHistory) {
            try {
                window.saccoHistory = JSON.parse(savedHistory);
                console.log('Loaded history from localStorage:', window.saccoHistory);
            } catch (e) {
                console.error('Corrupted local history:', e);
                window.saccoHistory = {};
            }
        } else {
            window.saccoHistory = {};
        }
    }

    // SHARED: Save history to server (primary) or localStorage (fallback)
    async function saveHistoryToServer(history) {
        if (!API_ENDPOINT || API_ENDPOINT === 'YOUR_API_ENDPOINT') {
            console.warn('API endpoint not set; saving to localStorage only');
            localStorage.setItem('saccoHistory', JSON.stringify(history));
            return;
        }
        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(history)
            });
            if (!response.ok) throw new Error('Save failed');
            console.log('Saved shared history to server');
            // Sync to local
            localStorage.setItem('saccoHistory', JSON.stringify(history));
        } catch (e) {
            console.error('Server save failed:', e);
            localStorage.setItem('saccoHistory', JSON.stringify(history)); // Fallback
        }
    }

    // Persist today data (unchanged)
    function saveTodayData() {
        if (window.saccoData?.today) {
            localStorage.setItem('saccoDataToday', JSON.stringify(window.saccoData.today));
        }
    }

    // Change detection (unchanged)
    function hasDataChanged(today, existing) {
        if (!existing) return true;
        const keys = ['members', 'contributions', 'loans', 'bankBalance', 'profit', 'roa'];
        return keys.some(key => {
            const newVal = today[key];
            const oldVal = existing[key];
            return newVal !== oldVal && (newVal == null || oldVal == null || String(newVal).trim() !== String(oldVal).trim());
        });
    }

    // Save function (now server-aware)
    async function saveCurrentMonth(isManual = false) {
        loadTodayData();
        if (!window.saccoData?.today) {
            if (isManual) alert("No current data. Visit homepage for carousel metrics.");
            return;
        }
        const today = { ...window.saccoData.today };
        if (typeof today.roa === 'string') today.roa = parseFloat(today.roa);
        if (isNaN(today.members) || isNaN(today.contributions)) {
            if (isManual) alert("Invalid data. Check carousel.");
            return;
        }
        await loadHistoryFromServer(); // Ensure latest shared
        if (!window.saccoHistory) window.saccoHistory = {};
        const date = new Date();
        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        const existing = window.saccoHistory[key];
        if (!hasDataChanged(today, existing)) {
            if (isManual) alert(`No changes. Up-to-date as of ${existing?.dateSaved || 'N/A'}.`);
            return;
        }
        window.saccoHistory[key] = {
            period: key,
            members: today.members,
            contributions: today.contributions,
            loans: today.loans || 0,
            bankBalance: today.bankBalance || 0,
            profit: today.profit || 0,
            roa: today.roa || 0,
            dateSaved: date.toISOString().split('T')[0]
        };
        await saveHistoryToServer(window.saccoHistory);
        renderFullHistory();
        const action = existing ? 'UPDATED' : 'SAVED';
        const msg = `${action} shared monthly data ${key}! (Members: ${today.members.toLocaleString()})`;
        if (isManual) alert(msg);
        else console.log('AUTO-' + msg);
    }

    // Render (unchanged, but now shows shared data)
    function renderFullHistory() {
        const tableContainer = document.getElementById('fullHistoryTable');
        const footer = document.getElementById('historyFooter');
        if (!tableContainer) return;
        if (!window.saccoHistory || Object.keys(window.saccoHistory).length === 0) {
            tableContainer.innerHTML = `<p style="text-align:center; color:#6b7280; padding:40px;">No shared monthly data yet. Click SAVE to start! (Sourced from carousel)</p>`;
            footer.textContent = "Start building shared monthly growth.";
            return;
        }
        const periods = Object.keys(window.saccoHistory).sort().reverse();
        const currentMonth = new Date().toISOString().slice(0,7);
        tableContainer.innerHTML = `
            <table>
                <thead><tr><th>Period</th><th>Members</th><th>Contributions</th><th>Loans</th><th>Bank Balance</th><th>ROA %</th><th>Saved On</th></tr></thead>
                <tbody>${periods.map(key => {
                    const d = window.saccoHistory[key];
                    const isCurrent = key === currentMonth;
                    return `<tr ${isCurrent ? 'class="current-month"' : ''}>
                        <td style="font-weight:900; color:#004d1a;">${d.period || key}</td>
                        <td>${d.members?.toLocaleString() || '—'}</td>
                        <td>KSh ${d.contributions?.toLocaleString() || '—'}</td>
                        <td>KSh ${d.loans?.toLocaleString() || '—'}</td>
                        <td>KSh ${d.bankBalance?.toLocaleString() || '—'}</td>
                        <td style="color:#10B981; font-weight:bold;">${d.roa || '—'}%</td>
                        <td>${d.dateSaved || '—'}</td>
                    </tr>`;
                }).join('')}</tbody>
            </table>`;
        const totalSize = (JSON.stringify(window.saccoHistory).length / 1024).toFixed(1);
        footer.innerHTML = `Total Records: <strong>${periods.length}</strong> | First: <strong>${periods[periods.length-1]}</strong> | Latest: <strong>${periods[0]}</strong> | <span style="color:#10B981;">~${totalSize} KB (Shared via server)</span>`;
    }

    // Download (unchanged)
    function downloadHistoryCSV() {
        if (!window.saccoHistory || Object.keys(window.saccoHistory).length === 0) return alert("No data to download.");
        const periods = Object.keys(window.saccoHistory).sort();
        let csv = "Period,Members,Contributions (KSh),Loans (KSh),Bank Balance (KSh),ROA %,Date Saved\n";
        periods.forEach(key => {
            const d = window.saccoHistory[key];
            csv += `${d.period || key},${d.members || ''},${d.contributions || ''},${d.loans || ''},${d.bankBalance || ''},${d.roa || ''},${d.dateSaved || ''}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `SOYOSOYO_SACCO_MONTHLY_HISTORY_${new Date().getFullYear()}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    // Reload (forces server/local load)
    async function reloadHistory() {
        console.log('Manual reload...');
        await loadHistoryFromServer();
        renderFullHistory();
        alert('Shared history reloaded!');
    }

    // AUTO-RENDER: Robust multi-load for refresh/code updates
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('Page loaded, initializing shared history');
        await loadHistoryFromServer();
        renderFullHistory();
        setTimeout(() => { loadHistoryFromServer(); renderFullHistory(); }, 500);
        setTimeout(() => { loadHistoryFromServer(); renderFullHistory(); }, 1500);
    });

    // AUTO-SAVE ON CAROUSEL UPDATE (site-wide shared)
    window.addEventListener('saccoDataUpdated', async () => {
        saveTodayData();
        await saveCurrentMonth(false); // Silent auto-save if changed
        renderFullHistory();
    });

    // Fallback fetch for today data
    setTimeout(() => {
        if (!window.saccoData) {
            fetch('https://soyosoyosacco.com/data.json')
                .then(r => r.json())
                .then(d => {
                    window.saccoData = d;
                    window.dispatchEvent(new Event('saccoDataUpdated'));
                })
                .catch(e => console.error('Data fetch failed:', e));
        }
    }, 1000);
</script>

<script>
  // AUTO-YEAR MAGIC (unchanged)
  document.addEventListener('DOMContentLoaded', () => {
    const currentYear = new Date().getFullYear();
    document.querySelectorAll('footer p').forEach(el => {
      if (el.textContent.includes('©')) el.innerHTML = el.innerHTML.replace(/\d{4}/, currentYear);
    });
    document.querySelectorAll('.history-header').forEach(el => {
      if (el.textContent.includes('2025')) el.textContent = el.textContent.replace('2025', currentYear);
    });
    document.querySelectorAll('*').forEach(el => {
      if (el.textContent.includes('2025 – Present')) el.innerHTML = el.innerHTML.replace(/2025(?=\s*[–-]\s*Present)/g, currentYear);
    });
  });
</script>
</body>
</html>
