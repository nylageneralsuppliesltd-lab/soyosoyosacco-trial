<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>About Us | Soyosoyo SACCO</title>
    <meta name="description" content="From 1998 Medicare roots to modern financial empowerment. The full story of Soyosoyo SACCO.">
    <link rel="stylesheet" href="style.css?v=46">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .history-section{margin:80px 0;padding:30px;background:#f8fdfa;border-radius:24px;border:2px solid #86efac;box-shadow:0 15px 40px rgba(0,0,0,0.08);font-family:'Lato',sans-serif}
        .history-header{text-align:center;color:#004d1a;font-size:2rem;font-weight:900;margin-bottom:20px}
        .history-controls{text-align:center;margin:20px 0;gap:15px;display:flex;flex-wrap:wrap;justify-content:center}
        .btn{padding:12px 28px;border:none;border-radius:50px;font-weight:900;font-size:14px;cursor:pointer;transition:all .3s}
        .btn-save{background:#10B981;color:white}
        .btn-save:hover{background:#059669;transform:translateY(-2px)}
        .btn-download{background:#004d1a;color:white}
        .btn-download:hover{background:#166534;transform:translateY(-2px)}
        .btn-social{background:#1DA1F2;color:white}
        .btn-social:hover{background:#0d8bd9;transform:translateY(-2px)}
        .btn-auto-save{background:#f59e0b;color:white;margin-left:10px}
        .btn-auto-save:hover{background:#d97706;transform:translateY(-2px)}
        #fullHistoryTable{overflow-x:auto;margin-top:20px;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,0.1);-webkit-overflow-scrolling:touch}
        #fullHistoryTable table{width:100%;min-width:1300px;border-collapse:collapse;background:white;table-layout:fixed}
        #fullHistoryTable th{background:#004d1a;color:white;padding:16px 8px;text-align:center;font-weight:900;font-size:14px;white-space:nowrap}
        #fullHistoryTable td{padding:14px 8px;text-align:center;border-bottom:1px solid #e6f4ea;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        #fullHistoryTable tr:hover{background:#fff8e1 !important}
        #fullHistoryTable tr:nth-child(even){background:#f0fdf4}
        #fullHistoryTable td:nth-child(2),#fullHistoryTable td:nth-child(3),#fullHistoryTable td:nth-child(4),#fullHistoryTable td:nth-child(5),
        #fullHistoryTable td:nth-child(6),#fullHistoryTable td:nth-child(7),#fullHistoryTable td:nth-child(8),#fullHistoryTable td:nth-child(9),
        #fullHistoryTable td:nth-child(10),#fullHistoryTable td:nth-child(11),#fullHistoryTable td:nth-child(12),#fullHistoryTable td:nth-child(13){text-align:right}
        .history-footer{text-align:center;margin-top:20px;color:#004d1a;font-weight:bold;font-size:15px}
        .current-month{background:#fff8e1 !important;font-weight:bold;box-shadow:inset 0 0 10px rgba(255,193,7,0.3)}
        @media (max-width:768px){
            .history-section{padding:20px;margin:40px 0}
            .history-header{font-size:1.5rem}
            .history-controls{flex-direction:column;align-items:center}
            .btn{width:90%;max-width:300px}
            #fullHistoryTable{overflow-x:hidden}
            #fullHistoryTable table{min-width:auto;font-size:12px;border:0}
            #fullHistoryTable thead{display:none}
            #fullHistoryTable tbody{display:flex;flex-direction:column;gap:8px}
            #fullHistoryTable tr{display:block;width:100%;margin-bottom:0;border:1px solid #e6f4ea;border-radius:12px;overflow:hidden;background:white;box-shadow:0 2px 8px rgba(0,0,0,0.05);transition:transform .2s;padding:8px}
            #fullHistoryTable tr:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.1)}
            #fullHistoryTable tr.current-month{border-color:#fbbf24;box-shadow:inset 0 0 10px rgba(255,193,7,0.3),0 2px 8px rgba(0,0,0,0.05)}
            #fullHistoryTable .period-header{padding:8px 12px;background:#f0fdf4;font-weight:700;color:#004d1a;font-size:14px;border-bottom:1px solid #e6f4ea;text-align:center}
            #fullHistoryTable .metrics-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:4px 12px;font-size:12px}
            #fullHistoryTable .metric-item{display:flex;justify-content:space-between;align-items:center;padding:2px 0;border-bottom:1px solid #f9f9f9}
            #fullHistoryTable .metric-label{font-weight:600;color:#666;font-size:10px;text-transform:uppercase;letter-spacing:0.5px}
            #fullHistoryTable .metric-value{font-weight:500;color:#004d1a}
            #fullHistoryTable .roa-value{color:#10B981}
            #fullHistoryTable .saved-on{display:block;width:100%;padding:6px 12px;text-align:center;background:#f8fdfa;color:#666;font-size:11px;border-top:1px solid #e6f4ea;margin-top:4px}
            #fullHistoryTable td{display:none}
            #TfullHistoryTable td:nth-of-type(1){display:block}
        }
    </style>
</head>
<body>

<header class="site-header">
    <div class="navbar">
        <a href="index.html"><img class="brand-logo round" src="assets/141dd3faa98da9737b591161deac509a.jpg" alt="Soyosoyo SACCO Logo"></a>
        <a href="https://chamasoft.com/login" class="member-portal">Member Portal</a>
        <button id="menu-toggle" aria-label="Toggle Menu"></button>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="Products.html">Products</a>
            <a href="Online-Forms.html">Online Forms</a>
            <a href="Jobs.html">Jobs</a>
            <a href="Join-Us.html">Join Us</a>
        </nav>
    </div>
</header>

<main class="container">
    <section class="section">
        <h1 style="text-align: center; margin-bottom: 1.5rem;">The Evolution of Soyosoyo SACCO</h1>
        <p style="text-align: justify; margin: 15px 0;">
            Soyosoyo SACCO boasts a rich history, beginning its journey on <strong>July 15, 1998</strong>, as <strong>SOYOSOYO MEDICARE CO-OPERATIVE SAVINGS & CREDIT SOCIETY</strong>. Its initial, heartwarming mission was to pool funds and provide affordable credit, primarily to help members cover their families' medical bills.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            As the fund grew significantly, the SACCO's vision expanded beyond healthcare. It began to support members in financing their children's education, demonstrating its adaptability and commitment to community needs.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            However, with its membership spreading across various parts of the Kenyan Coast, the complexity of managing the SACCO, combined with the introduction of the National Hospital Insurance Fund (NHIF) which began covering medical bills, led the SACCO into a period of silence.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            But the story didn't end there. In 2022, the dedicated founding members reignited their passion, showing a keen interest in reviving the SACCO. Their goal was clear: to refresh its objectives to align with current community needs.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            This revival culminated in a new beginning for Soyosoyo SACCO. Officially rebranded and given a new look on April 10, 2024, it emerged with renewed vigor. Its expanded mission now focuses on providing affordable financing to cover a broader range of essential objectives, including medical bills, education, agriculture, and development.
        </p>
        <p style="text-align: justify; margin: 15px 0;">
            Soyosoyo SACCO stands today as a testament to its enduring commitment to its members, evolving to meet the diverse financial needs of its community.
        </p>
        <div style="text-align: center; margin-top: 2rem;">
            <a href="index.html" class="products-button">Back to Home</a>
        </div>
    </section>

    <section class="history-section">
        <h2 class="history-header">Monthly Financial History (2025 – Present)</h2>
        <div class="history-controls">
            <button class="btn btn-save" onclick="saveCurrentMonth()">SAVE THIS MONTH'S DATA</button>
            <button class="btn btn-auto-save" onclick="toggleAutoSave()" id="autoSaveToggle">
                <span id="autoSaveText">AUTO-SAVE OFF</span>
            </button>
            <button class="btn btn-download" onclick="downloadHistoryCSV()">DOWNLOAD FULL HISTORY (CSV)</button>
            <button class="btn btn-social" onclick="postToSocials()">POST TO SOCIALS</button>
        </div>
        <div id="fullHistoryTable"></div>
        <div class="history-footer" id="historyFooter">Loading monthly records...</div>
    </section>
</main>

<footer>
    <p>© 2025–<span id="currentYear"></span> SOYOSOYO SACCO. All rights reserved. | <a href="mailto:info@soyosoyosacco.com">info@soyosoyosacco.com</a></p>
    <div class="social-icons">
        <a href="https://www.facebook.com/people/Soyosoyo-Sacco/61565783836766/" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="https://x.com/SoyosoyoSACCO" target="_blank" aria-label="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
        <a href="https://www.instagram.com/soyosoyosacco" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
    </div>
</footer>

<script src="scripts/main.js"></script>
<script src="scripts/carousel.js"></script>

<script>
  const API_BASE = 'https://soyosoyo-sacco-api.onrender.com/api';
  window.saccoHistory = {};
  window.saccoData = window.saccoData || {};
  let retryInterval = null;
  const RETRY_DELAY = 30000;
  let autoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
  let lastDataHash = '';

  function safeDate(dateInput) {
    if (!dateInput) return new Date();
    if (typeof dateInput === 'number' || !isNaN(dateInput)) return new Date(Number(dateInput));
    const d = new Date(dateInput);
    return isNaN(d.getTime()) ? new Date() : d;
  }

  function formatMonth(period) {
    const [y, m] = period.split('-');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return `${months[parseInt(m)-1]}-${y}`;
  }

  function formatDateTime(dateInput) {
    const d = safeDate(dateInput);
    const day = String(d.getDate()).padStart(2,'0');
    const month = d.toLocaleString('en-US',{month:'short'}).toUpperCase();
    const year = d.getFullYear();
    const time = d.toTimeString().slice(0,5);
    return `${day}-${month}-${year} ${time}`;
  }

  function formatDisplayDate(dateInput) {
    const d = safeDate(dateInput);
    return d.toLocaleString('en-KE', {day:'numeric', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit'}).replace(',','');
  }

  function getBankValue(breakdown, name) {
    if (!Array.isArray(breakdown)) return 0;
    const item = breakdown.find(b => b.name.includes(name) || b.name.toLowerCase().includes(name.toLowerCase()));
    return item ? Number(item.value || 0) : 0;
  }

  function computeDataHash(today) {
    if (!today) return '';
    const ef = today.extraFields || {};
    const bb = ef.bankBreakdown || [];
    return JSON.stringify({
      members: today.members,
      contributions: today.contributions,
      loansDisbursed: today.loansDisbursed,
      loansBalance: today.loansBalance,
      totalBankBalance: today.totalBankBalance,
      profit: today.profit,
      roa: today.roa,
      coopBank: getBankValue(bb, 'Co-operative'),
      chamasoft: getBankValue(bb, 'Chamasoft'),
      cytonn: getBankValue(bb, 'Cytonn'),
      totalAssets: Number(ef.bookValue || 0)
    });
  }

  function loadPersistedData() {
    const saved = localStorage.getItem('saccoHistoryBackup');
    if (saved) {
      const data = JSON.parse(saved);
      window.saccoHistory = {};
      data.forEach(row => { 
        window.saccoHistory[row.period] = { ...row, saveType: row.saveType || 'manual' };
      });
    }
  }

  function updateCurrentMonthInHistory(today, saveType = 'auto') {
    const currentPeriod = new Date().toISOString().slice(0, 7);
    const ef = today.extraFields || {};
    const bb = ef.bankBreakdown || [];
    window.saccoHistory[currentPeriod] = {
      period: currentPeriod,
      members: Number(today.members || 0),
      contributions: Number(today.contributions || 0),
      loansDisbursed: Number(today.loansDisbursed || 0),
      loansBalance: Number(today.loansBalance || 0),
      totalBankBalance: Number(today.totalBankBalance || 0),
      profit: Number(today.profit || 0),
      roa: Number(today.roa || 0),
      coopBank: getBankValue(bb, 'Co-operative'),
      chamasoft: getBankValue(bb, 'Chamasoft'),
      cytonn: getBankValue(bb, 'Cytonn'),
      totalAssets: Number(ef.bookValue || 0),
      extraFields: ef,
      dateSaved: new Date().toISOString(),
      saveType: saveType
    };
  }

  function renderFullHistory() {
    const container = document.getElementById('fullHistoryTable');
    const footer = document.getElementById('historyFooter');
    const history = Object.values(window.saccoHistory)
      .sort((a,b) => b.period.localeCompare(a.period));

    if (history.length === 0 && !window.saccoData?.today) {
      container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No history saved yet. Visit homepage → click SAVE to begin!</p>';
      footer.innerHTML = 'No records found.';
      return;
    }

    let tableHTML = `<table><thead><tr>
      <th>Period</th><th>Members</th><th>Contributions</th><th>Loans Disb.</th><th>Loans Bal.</th>
      <th>Total Bank Bal.</th><th>Coop Bank</th><th>Chamasoft</th><th>Cytonn</th><th>Total Assets</th>
      <th>Profit</th><th>ROA</th><th>Saved On</th>
    </tr></thead><tbody>`;

    const currentMonthKey = new Date().toISOString().slice(0,7);

    history.forEach(row => {
      const isCurrent = row.period === currentMonthKey;
      const saveTypeLabel = row.saveType === 'auto' ? '(Auto)' : '(Manual)';
      tableHTML += `<tr ${isCurrent?'class="current-month"':''}>
        <td data-label="Period">${formatMonth(row.period)}</td>
        <td data-label="Members">${Number(row.members).toLocaleString()}</td>
        <td data-label="Contributions">KSh ${Number(row.contributions).toLocaleString()}</td>
        <td data-label="Loans Disb.">KSh ${Number(row.loansDisbursed).toLocaleString()}</td>
        <td data-label="Loans Bal.">KSh ${Number(row.loansBalance).toLocaleString()}</td>
        <td data-label="Total Bank Bal.">KSh ${Number(row.totalBankBalance).toLocaleString()}</td>
        <td data-label="Coop Bank">KSh ${Number(row.coopBank).toLocaleString()}</td>
        <td data-label="Chamasoft">KSh ${Number(row.chamasoft).toLocaleString()}</td>
        <td data-label="Cytonn">KSh ${Number(row.cytonn).toLocaleString()}</td>
        <td data-label="Total Assets">KSh ${Number(row.totalAssets).toLocaleString()}</td>
        <td data-label="Profit">KSh ${Number(row.profit).toLocaleString()}</td>
        <td data-label="ROA" class="roa">${Number(row.roa).toFixed(1)}%</td>
        <td data-label="Saved On">${formatDisplayDate(row.dateSaved)} ${saveTypeLabel}</td>
      </tr>`;
    });

    tableHTML += '</tbody></table>';
    container.innerHTML = tableHTML;

    // Mobile view
    if (window.innerWidth <= 768) {
      const tbody = container.querySelector('tbody');
      if (tbody) {
        tbody.innerHTML = history.map(row => {
          const isCurrent = row.period === currentMonthKey;
          const saveTypeLabel = row.saveType === 'auto' ? '(Auto)' : '(Manual)';
          const periodHtml = `<div class="period-header ${isCurrent ? 'current-month' : ''}">${formatMonth(row.period)}</div>`;
          const metricsHtml = `
            <div class="metrics-grid">
              <div class="metric-item"><span class="metric-label">Members</span><span class="metric-value">${Number(row.members).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Contributions</span><span class="metric-value">KSh ${Number(row.contributions).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Loans Bal.</span><span class="metric-value">KSh ${Number(row.loansBalance).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Total Bank</span><span class="metric-value">KSh ${Number(row.totalBankBalance).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Coop Bank</span><span class="metric-value">KSh ${Number(row.coopBank).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Chamasoft</span><span class="metric-value">KSh ${Number(row.chamasoft).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Cytonn</span><span class="metric-value">KSh ${Number(row.cytonn).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Total Assets</span><span class="metric-value">KSh ${Number(row.totalAssets).toLocaleString()}</span></div>
              <div class="metric-item"><span class="metric-label">Profit</span><span class="metric-value">KSh ${Number(row.profit).toLocaleString()}</span></div>
            </div>
            <div class="saved-on">
              <span class="metric-label">ROA:</span> <span class="roa-value">${Number(row.roa).toFixed(1)}%</span> | Saved: ${formatDisplayDate(row.dateSaved)} ${saveTypeLabel}
            </div>
          `;
          return `<tr class="${isCurrent ? 'current-month' : ''}">${periodHtml}${metricsHtml}</tr>`;
        }).join('');
      }
    }

    const latest = history[0];
    const saveTypeLabel = latest.saveType === 'auto' ? '(Auto)' : '(Manual)';
    footer.innerHTML = `
      <strong>${history.length}</strong> months saved 
      <span style="color:#10B981;">| Latest: ${formatMonth(latest.period)}</span>
      <span style="color:#004d1a;">| Saved: ${formatDisplayDate(latest.dateSaved)} ${saveTypeLabel}</span>
    `;
  }

  async function loadLiveHistory() {
    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 15000);
      const res = await fetch(`${API_BASE}/history`, {signal: controller.signal, cache:'no-store'});
      clearTimeout(timeout);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      window.saccoHistory = {};
      data.forEach(row => {
        const ef = row.extraFields ? JSON.parse(row.extraFields) : {};
        const bb = ef.bankBreakdown || [];
        window.saccoHistory[row.period] = {
          period: row.period,
          members: Number(row.members || 0),
          contributions: Number(row.contributions || 0),
          loansDisbursed: Number(row.loansDisbursed || 0),
          loansBalance: Number(row.loansBalance || 0),
          totalBankBalance: Number(row.totalBankBalance || 0),
          profit: Number(row.profit || 0),
          roa: Number(row.roa || 0),
          coopBank: getBankValue(bb, 'Co-operative'),
          chamasoft: getBankValue(bb, 'Chamasoft'),
          cytonn: getBankValue(bb, 'Cytonn'),
          totalAssets: Number(ef.bookValue || 0),
          extraFields: ef,
          dateSaved: row.dateSaved,
          saveType: 'manual'
        };
      });
      localStorage.setItem('saccoHistoryBackup', JSON.stringify(Object.values(window.saccoHistory)));
    } catch (err) {
      console.warn('Server sleeping → using local backup', err);
      loadPersistedData();
    } finally {
      initCarouselData();
      if (window.saccoData?.today) {
        const currentHash = computeDataHash(window.saccoData.today);
        const isDataChanged = currentHash !== lastDataHash;
        if (isDataChanged) {
          updateCurrentMonthInHistory(window.saccoData.today, 'auto');
          lastDataHash = currentHash;
        }
      }
      renderFullHistory();
    }
  }

  function initCarouselData() {
    if (!window.saccoData?.today) {
      const savedData = localStorage.getItem('saccoDataToday');
      if (savedData) {
        window.saccoData.today = JSON.parse(savedData);
      }
    }
    if (typeof window.updateCarouselData === 'function') {
      window.updateCarouselData();
    }
  }

  async function attemptSave(payload, saveType = 'auto') {
    try {
      const res = await fetch(`${API_BASE}/history/save`, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok) { const text = await res.text(); throw new Error(text || res.status); }
      const result = await res.json();
      return { success: true, data: { ...result.data, saveType } };
    } catch (err) {
      return { success: false, error: err.message };
    }
  }

  async function saveCurrentMonth(auto = false) {
    if (!window.saccoData?.today) {
      if (!auto) alert("Data not ready!\n\nVisit HOMEPAGE to populate, then return.");
      return;
    }
    const today = window.saccoData.today;
    const ef = today.extraFields || {};
    const bb = ef.bankBreakdown || [];
    const saveType = auto ? 'auto' : 'manual';
    const payload = {
      members: today.members,
      contributions: today.contributions,
      loansDisbursed: today.loansDisbursed,
      loansBalance: today.loansBalance,
      total_bank_balance: today.totalBankBalance,
      profit: today.profit,
      roa: parseFloat(today.roa) || 0,
      extraFields: JSON.stringify(ef)
    };
    const saveAttempt = await attemptSave(payload, saveType);
    if (saveAttempt.success) {
      clearRetryInterval();
      localStorage.removeItem('pendingSave');
      lastDataHash = computeDataHash(today);
      updateCurrentMonthInHistory(today, saveType);
      renderFullHistory();
      if (!auto) {
        alert(`SAVED SUCCESSFULLY!\nMonth: ${formatMonth(saveAttempt.data.period)}\nSaved at: ${formatDateTime(saveAttempt.data.dateSaved)}`);
      } else {
        console.log(`Auto-saved: ${formatMonth(saveAttempt.data.period)}`);
      }
      loadLiveHistory();
    } else {
      localStorage.setItem('pendingSave', JSON.stringify({ ...payload, queuedAt: new Date().toISOString(), saveType }));
      if (!auto) {
        startRetry(payload, saveType);
        alert(`Save queued – server sleeping. Retrying every 30s...\nError: ${saveAttempt.error}`);
      }
    }
  }

  function startRetry(payload, saveType) {
    if (retryInterval) clearRetryInterval();
    let retryCount = 0;
    const maxRetries = 10;
    retryInterval = setInterval(async () => {
      retryCount++;
      const saveAttempt = await attemptSave(payload, saveType);
      if (saveAttempt.success) {
        clearRetryInterval();
        localStorage.removeItem('pendingSave');
        lastDataHash = computeDataHash(window.saccoData?.today);
        updateCurrentMonthInHistory(window.saccoData.today, saveType);
        renderFullHistory();
        console.log(`Auto-retry saved after ${retryCount} attempts`);
        loadLiveHistory();
      } else if (retryCount >= maxRetries) {
        clearRetryInterval();
      }
    }, RETRY_DELAY);
  }

  function clearRetryInterval() {
    if (retryInterval) {
      clearInterval(retryInterval);
      retryInterval = null;
    }
  }

  function toggleAutoSave() {
    autoSaveEnabled = !autoSaveEnabled;
    localStorage.setItem('autoSaveEnabled', autoSaveEnabled);
    document.getElementById('autoSaveText').textContent = autoSaveEnabled ? 'AUTO-SAVE ON' : 'AUTO-SAVE OFF';
    document.getElementById('autoSaveToggle').style.background = autoSaveEnabled ? '#10B981' : '#f59e0b';
    if (autoSaveEnabled) saveCurrentMonth(true);
  }

  function checkPendingSave() {
    const pending = localStorage.getItem('pendingSave');
    if (pending) {
      const { saveType, ...payload } = JSON.parse(pending);
      console.log('Pending save detected – retrying...');
      startRetry(payload, saveType);
    }
  }

  function downloadHistoryCSV() {
    const history = Object.values(window.saccoHistory);
    if (history.length === 0) { alert("No data to download yet."); return; }

    let csv = "Period,Members,Contributions,Loans Disbursed,Loans Balance,Total Bank Balance,Coop Bank,Chamasoft,Cytonn,Total Assets,Profit,ROA %,Saved On,Save Type\n";
    history.sort((a,b)=>a.period.localeCompare(b.period)).forEach(d => {
      const saveTypeLabel = d.saveType === 'auto' ? 'Auto' : 'Manual';
      csv += `${formatMonth(d.period)},${d.members},${d.contributions},${d.loansDisbursed},${d.loansBalance},${d.totalBankBalance},${d.coopBank},${d.chamasoft},${d.cytonn},${d.totalAssets},${d.profit},${d.roa},"${formatDateTime(d.dateSaved)}",${saveTypeLabel}\n`;
    });

    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Soyosoyo_SACCO_History_${new Date().getFullYear()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function postToSocials() {
    const history = Object.values(window.saccoHistory);
    if (history.length === 0) {
      alert("No data saved yet! Click SAVE first.");
      return;
    }
    const latest = history.sort((a,b) => b.period.localeCompare(a.period))[0];
    const prev = history.sort((a,b) => b.period.localeCompare(a.period))[1];

    const monthName = formatMonth(latest.period);
    const savedTime = formatDateTime(latest.dateSaved);

    const memberGrowth = prev ? ` (+${latest.members - prev.members})` : '';
    const contribGrowth = prev ? ` (+KSh ${(latest.contributions - prev.contributions).toLocaleString()})` : '';

    const message = `Soyosoyo SACCO – ${monthName} Update

Members: ${latest.members.toLocaleString()}${memberGrowth}
Contributions: KSh ${latest.contributions.toLocaleString()}${contribGrowth}
Loans Disbursed: KSh ${latest.loansDisbursed.toLocaleString()}
Loans Balance: KSh ${latest.loansBalance.toLocaleString()}
Total Bank Balance: KSh ${latest.totalBankBalance.toLocaleString()}
Co-operative Bank: KSh ${latest.coopBank.toLocaleString()}
Chamasoft: KSh ${latest.chamasoft.toLocaleString()}
Cytonn: KSh ${latest.cytonn.toLocaleString()}
Total Assets: KSh ${latest.totalAssets.toLocaleString()}
Profit: KSh ${latest.profit.toLocaleString()}
ROA: ${latest.roa.toFixed(1)}%

Saved on ${savedTime}
We are growing stronger every month!

#SoyosoyoSACCO #CoopPower #Mombasa #KenyaCoast
https://soyosoyo-sacco-api.onrender.com`;

    navigator.clipboard.writeText(message).then(() => alert("Post copied! Opening socials..."));
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`,'_blank');
    window.open(`https://www.facebook.com/sharer/sharer.php?u=https://soyosoyo-sacco-api.onrender.com&quote=${encodeURIComponent(message)}`,'_blank');
    window.open(`https://wa.me/?text=${encodeURIComponent(message)}`,'_blank');
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('currentYear').textContent = new Date().getFullYear();
    checkPendingSave();
    loadLiveHistory();

    document.getElementById('autoSaveText').textContent = autoSaveEnabled ? 'AUTO-SAVE ON' : 'AUTO-SAVE OFF';
    document.getElementById('autoSaveToggle').style.background = autoSaveEnabled ? '#10B981' : '#f59e0b';

    setInterval(() => {
      initCarouselData();
      if (window.saccoData?.today) {
        const currentHash = computeDataHash(window.saccoData.today);
        const isDataChanged = currentHash !== lastDataHash;
        if (isDataChanged) {
          console.log('Data changed detected');
          updateCurrentMonthInHistory(window.saccoData.today, 'auto');
          renderFullHistory();
          lastDataHash = currentHash;
          if (autoSaveEnabled) {
            setTimeout(() => saveCurrentMonth(true), 5000);
          }
        }
      }
    }, 2000);
  });
</script>
</body>
</html>
