<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>About Us | Soyosoyo SACCO</title>
<meta name="description" content="From 1998 Medicare roots to modern financial empowerment. The full story of Soyosoyo SACCO.">
<link rel="stylesheet" href="style.css?v=50">
<link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
/* ==================== HISTORY SECTION CSS ==================== */
.history-section{margin:80px 0;padding:30px;background:#f8fdfa;border-radius:24px;border:2px solid #86efac;box-shadow:0 15px 40px rgba(0,0,0,0.08);font-family:'Lato',sans-serif}
.history-header{text-align:center;color:#004d1a;font-size:2rem;font-weight:900;margin-bottom:20px}
.history-controls{text-align:center;margin:20px 0;gap:15px;display:flex;flex-wrap:wrap;justify-content:center}
.btn{padding:12px 28px;border:none;border-radius:50px;font-weight:900;font-size:14px;cursor:pointer;transition:all .3s}
.btn-save{background:#10B981;color:white}
.btn-save:hover{background:#059669;transform:translateY(-2px)}
.btn-download{background:#004d1a;color:white}
.btn-download:hover{background:#166534;transform:translateY(-2px)}
.btn-social{background:#1DA1F2;color:white}
.btn-social:hover{background:#0d8bd9;transform:translateY(-2px)}
.btn-auto-save{background:#f59e0b;color:white;margin-left:10px}
.btn-auto-save:hover{background:#d97706;transform:translateY(-2px)}
#fullHistoryTable{overflow-x:auto;margin-top:20px;border-radius:16px;box-shadow:0 8px 25px rgba(0,0,0,0.1);-webkit-overflow-scrolling:touch}
#fullHistoryTable table{width:100%;min-width:1400px;border-collapse:separate;border-spacing:0 8px;background:transparent}
#fullHistoryTable thead th{background:#004d1a;color:white;padding:18px 12px;text-align:center;font-weight:900;font-size:15px;white-space:normal;line-height:1.3}
#fullHistoryTable tbody td{padding:16px 12px;text-align:right;font-size:15px;background:white;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05)}
#fullHistoryTable tbody tr:hover td{background:#fff8e1 !important}
#fullHistoryTable tbody tr:nth-child(even) td{background:#f0fdf4}
#fullHistoryTable tbody td:first-child{text-align:center;background:#f8fdfa !important;font-weight:700;color:#004d1a}
#fullHistoryTable .current-month td{background:#fff8e1 !important;font-weight:bold;box-shadow:inset 0 0 10px rgba(255,193,7,0.3)}
.history-footer{text-align:center;margin-top:30px;color:#004d1a;font-weight:bold;font-size:16px}

/* Mobile Enhanced Card Layout */
@media (max-width:768px){
    .history-section{padding:20px;margin:40px 0}
    .history-header{font-size:1.6rem}
    .history-controls{flex-direction:column;align-items:center}
    .btn{width:90%;max-width:320px;font-size:15px}
    #fullHistoryTable{overflow-x:hidden}
    #fullHistoryTable table{min-width:auto;border:0}
    #fullHistoryTable thead{display:none}
    #fullHistoryTable tbody{display:flex;flex-direction:column;gap:12px}
    #fullHistoryTable tr{display:block;width:100%;border:1px solid #86efac;border-radius:16px;overflow:hidden;background:white;box-shadow:0 4px 15px rgba(0,0,0,0.08);transition:transform .2s}
    #fullHistoryTable tr:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.12)}
    #fullHistoryTable tr.current-month{border:2px solid #fbbf24;box-shadow:0 0 20px rgba(251,191,36,0.3)}
    .history-card{margin-bottom:20px;padding:0;border-radius:20px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.1);background:white;transition:transform .3s, box-shadow .3s;border:1px solid #e6f4ea}
    .history-card:hover{transform:translateY(-5px);box-shadow:0 15px 40px rgba(0,0,0,0.15)}
    .history-card.current-month{border-left:5px solid #10B981;background:linear-gradient(135deg, #f0fdf4 0%, #fff8e1 100%);box-shadow:0 10px 35px rgba(16,185,129,0.2)}
    .card-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:linear-gradient(135deg, #004d1a 0%, #166534 100%);color:white;font-weight:900}
    .card-header h3{margin:0;font-size:18px;text-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .tag{padding:4px 12px;border-radius:20px;font-size:12px;font-weight:700;background:#10B981;color:white;letter-spacing:0.5px}
    .tag.live{background:#fbbf24;color:#004d1a}
    .tag.db{background:#6b7280;color:white}
    .card-grid{display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;padding:16px}
    .card-grid > div{display:flex;flex-direction:column;justify-content:center;align-items:center;padding:8px 4px;border:1px solid #e6f4ea;border-radius:8px;background:#f8fdfa;transition:all .2s;font-weight:700;text-align:center}
    .card-grid > div:hover{transform:scale(1.02);background:#fff8e1;border-color:#fbbf24;box-shadow:0 2px 8px rgba(251,191,36,0.15)}
    .card-grid span{font-size:10px;font-weight:600;color:#374151;margin-bottom:2px;text-transform:uppercase;letter-spacing:0.3px}
    .card-grid strong{font-size:12px;font-weight:900;color:#004d1a;letter-spacing:0.2px}
    .card-grid .roa-value strong{color:#d97706}
    .card-footer{padding:12px 20px;background:#f8fdfa;border-top:1px solid #e6f4ea;text-align:center;font-size:12px;color:#6b7280;font-style:italic}
    .card-footer strong{color:#004d1a}
}
</style>
</head>
<body>

<header class="site-header">
    <div class="navbar">
        <a href="index.html"><img class="brand-logo round" src="assets/141dd3faa98da9737b591161deac509a.jpg" alt="Soyosoyo SACCO Logo"></a>
        <a href="https://chamasoft.com/login" class="member-portal">Member Portal</a>
        <button id="menu-toggle" aria-label="Toggle Menu"></button>
        <nav class="nav-links">
            <a href="index.html">Home</a>
            <a href="Products.html">Products</a>
            <a href="Online-Forms.html">Online Forms</a>
            <a href="Jobs.html">Jobs</a>
            <a href="Join-Us.html">Join Us</a>
        </nav>
    </div>
</header>

<main class="container">
    <section class="section">
        <h1 style="text-align: center; margin-bottom: 1.5rem;">The Evolution of Soyosoyo SACCO</h1>
        <p style="text-align: justify; margin: 15px 0;">Soyosoyo SACCO boasts a rich history, beginning its journey on <strong>July 15, 1998</strong>, as <strong>SOYOSOYO MEDICARE CO-OPERATIVE SAVINGS & CREDIT SOCIETY</strong>. Its initial, heartwarming mission was to pool funds and provide affordable credit, primarily to help members cover their families' medical bills.</p>
        <p style="text-align: justify; margin: 15px 0;">As the fund grew significantly, the SACCO's vision expanded beyond healthcare. It began to support members in financing their children's education, demonstrating its adaptability and commitment to community needs.</p>
        <p style="text-align: justify; margin: 15px 0;">However, with its membership spreading across various parts of the Kenyan Coast, the complexity of managing the SACCO, combined with the introduction of the National Hospital Insurance Fund (NHIF) which began covering medical bills, led the SACCO into a period of silence.</p>
        <p style="text-align: justify; margin: 15px 0;">But the story didn't end there. In 2022, the dedicated founding members reignited their passion, showing a keen interest in reviving the SACCO. Their goal was clear: to refresh its objectives to align with current community needs.</p>
        <p style="text-align: justify; margin: 15px 0;">This revival culminated in a new beginning for Soyosoyo SACCO. Officially rebranded and given a new look on <strong>April 10, 2024</strong>, it emerged with renewed vigor. Its expanded mission now focuses on providing affordable financing to cover a broader range of essential objectives, including medical bills, education, agriculture, and development.</p>
        <p style="text-align: justify; margin: 15px 0;">Soyosoyo SACCO stands today as a testament to its enduring commitment to its members, evolving to meet the diverse financial needs of its community.</p>
        <div style="text-align: center; margin-top: 2rem;">
            <a href="index.html" class="products-button">Back to Home</a>
        </div>
    </section>

    <section class="history-section">
        <h2 class="history-header">Monthly Financial History (2025 – Present)</h2>
        <div class="history-controls">
            <button class="btn btn-save" onclick="saveCurrentMonth()">SAVE THIS MONTH'S DATA</button>
            <button class="btn btn-auto-save" onclick="toggleAutoSave()" id="autoSaveToggle">
                <span id="autoSaveText">AUTO-SAVE OFF</span>
            </button>
            <button class="btn btn-download" onclick="downloadHistoryCSV()">DOWNLOAD FULL HISTORY (CSV)</button>
            <button class="btn btn-social" onclick="sendMonthlyEmail()">POST TO EMAIL</button>
        </div>
        <div id="fullHistoryTable"></div>
        <div class="history-footer" id="historyFooter">Loading monthly records...</div>
    </section>
</main>

<footer>
    <p>© 2025–<span id="autoYearNow"></span> SOYOSOYO SACCO. All rights reserved. | <a href="mailto:info@soyosoyosacco.com">info@soyosoyosacco.com</a></p>
    <div class="social-icons">
        <a href="https://www.facebook.com/people/Soyosoyo-Sacco/61565783836766/" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
        <a href="https://x.com/SoyosoyoSACCO" target="_blank" aria-label="X (Twitter)"><i class="fab fa-x-twitter"></i></a>
        <a href="https://www.instagram.com/soyosoyosacco" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
    </div>
</footer>

<!-- ======================= ALL YOUR SCRIPTS (100% COMPLETE & FIXED) ======================= -->
<script>
  document.getElementById('autoYearNow').textContent = new Date().getFullYear();
</script>

<script src="scripts/carousel.js"></script>

<script>
// ==================== PERMANENT FIX FOR THE BUG ====================
// This single line eliminates the "Cannot set properties of undefined" error forever
window.saccoHistory = window.saccoHistory || {};

// ==================== CONFIG ====================
const API_BASE = 'https://soyosoyo-sacco-api.onrender.com/api';
const CACHE_KEY = 'soyosoyoSaccoHistory';
const MAX_RETRIES = 50;
let autoSaveEnabled = localStorage.getItem('autoSaveEnabled') === 'true';
let retryCount = 0;
let lastDataHash = '';
let autoSyncTimeout = null;
let silentWatcherActive = false;
let forceAutoSave = false;

// ==================== UTILS ====================
function getCurrentPeriod() {
    return new Date().toISOString().slice(0, 7); // YYYY-MM
}

function formatMonth(period) {
    const [y, m] = period.split('-');
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return `${months[parseInt(m)-1]} ${y}`;
}

function formatDisplayDate(d) {
    return new Date(d).toLocaleString('en-KE',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}).replace(',','');
}

function recordsDiffer(live, db) {
    const keys = ['members','contributions','loansDisbursed','loansBalance','totalBankBalance','coopBank','chamasoft','cytonn','totalAssets','profit','roa'];
    return keys.some(k => Math.abs(Number(live[k]||0)-Number(db[k]||0))>0.5);
}

function fmt(num) { return (num == null || isNaN(num)) ? '0' : Number(num).toLocaleString(); }

function convertHistoryToCSV(history) {
    const headers = ["Period","Members","Savings","Loans Disbursed","Loans Balance","Total Bank","Co-op","Chamasoft","Cytonn","Total Assets","Profit","ROA","Saved On"];
    const rows = history.map(r => [
        r.period,
        r.members,
        r.contributions,
        r.loansDisbursed,
        r.loansBalance,
        r.totalBankBalance,
        r.coopBank,
        r.chamasoft,
        r.cytonn,
        r.totalAssets,
        r.profit,
        r.roa,
        r.dateSaved
    ]);
    return [headers, ...rows].map(r => r.join(",")).join("\n");
}

// ==================== CACHE (NOW BULLETPROOF) ====================
function loadCache() {
    window.saccoHistory = window.saccoHistory || {};
    try {
        const cached = localStorage.getItem(CACHE_KEY);
        if(cached) {
            const parsed = JSON.parse(cached);
            if (parsed && typeof parsed === 'object') window.saccoHistory = parsed;
        }
    } catch(e) {
        console.warn("Cache corrupt – resetting", e);
        window.saccoHistory = {};
        localStorage.removeItem(CACHE_KEY);
    }
}

// ==================== LAZY LOAD RENDERER (exact same behaviour as before) ====================
function renderHistoryLazy() {
    const container = document.getElementById('fullHistoryTable');
    const cur = getCurrentPeriod();
    const isMobile = window.innerWidth <= 768;
    const limit = isMobile ? MOBILE_LIMIT : DESKTOP_LIMIT;

    // CORRECT WAY: include both live and _db records, but show _db only for current month
    const history = Object.keys(window.saccoHistory)
        .map(key => {
            const record = window.saccoHistory[key];
            const isDbEntry = key.endsWith('_db');
            const displayPeriod = isDbEntry ? key.slice(0, -3) : key;

            // Show _db version only for current month, never for past months
            if (isDbEntry && displayPeriod !== cur) return null;

            return {
                ...record,
                period: displayPeriod,
                saveType: isDbEntry ? 'db' : (record.saveType || 'live'),
                __sortKey: key
            };
        })
        .filter(Boolean)
        .sort((a, b) => {
            if (a.period !== b.period) return b.period.localeCompare(a.period);
            return a.saveType === 'live' ? -1 : 1; // LIVE always on top for current month
        });

    const slice = history.slice(0, currentDisplayCount + limit);
    const prevCount = currentDisplayCount;
    currentDisplayCount = slice.length;

    if (slice.length === 0) {
        container.innerHTML = '<p style="text-align:center;padding:40px;color:#666;">Loading history...</p>';
        return;
    }

    let html = '';
    if (isMobile) {
        html = slice.map(r => {
            const tagClass = r.saveType === 'live' ? 'tag live' : 'tag db';
            const tagText = r.saveType === 'live' ? 'LIVE' : 'SYNCED';
            return `<div class="history-card ${r.period === cur ? 'current-month' : ''}">
                <div class="card-header"><h3>${formatMonth(r.period)}</h3><span class="${tagClass}">${tagText}</span></div>
                <div class="card-grid">
                    <div><span>Members</span><strong>${fmt(r.members)}</strong></div>
                    <div><span>Savings</span><strong>${fmt(r.contributions)}</strong></div>
                    <div><span>Loans Out</span><strong>${fmt(r.loansDisbursed)}</strong></div>
                    <div><span>Loans Bal.</span><strong>${fmt(r.loansBalance)}</strong></div>
                    <div><span>Bank Total</span><strong>${fmt(r.totalBankBalance)}</strong></div>
                    <div><span>Co-op</span><strong>${fmt(r.coopBank)}</strong></div>
                    <div><span>Chamasoft</span><strong>${fmt(r.chamasoft)}</strong></div>
                    <div><span>Cytonn</span><strong>${fmt(r.cytonn)}</strong></div>
                    <div><span>Assets</span><strong>${fmt(r.totalAssets)}</strong></div>
                    <div><span>Profit</span><strong>${fmt(r.profit)}</strong></div>
                    <div class="roa-value"><span>ROA</span><strong>${r.roa ? Number(r.roa).toFixed(1) : '0.0'}%</strong></div>
                </div>
                <div class="card-footer"><strong>Saved:</strong> ${formatDisplayDate(r.dateSaved)}</div>
            </div>`;
        }).join('');
    } else {
        html = `<table><thead><tr>
            <th>Period</th><th>Members</th><th>Contributions</th><th>Loans Disbursed</th><th>Loans Balance</th>
            <th>Total Bank</th><th>Co-op</th><th>Chamasoft</th><th>Cytonn</th><th>Total Assets</th><th>Profit</th><th>ROA %</th><th>Saved On</th></tr></thead><tbody>`;
        slice.forEach(r => {
            const bg = r.saveType === 'live' ? 'background:#fffbe6' : 'background:#f0fdf4';
            const label = r.saveType === 'live' ? '(LIVE)' : '(SYNCED)';
            html += `<tr ${r.period === cur ? 'class="current-month"' : ''} style="${bg}">
                <td>${formatMonth(r.period)}</td><td>${fmt(r.members)}</td><td>${fmt(r.contributions)}</td>
                <td>${fmt(r.loansDisbursed)}</td><td>${fmt(r.loansBalance)}</td><td>${fmt(r.totalBankBalance)}</td>
                <td>${fmt(r.coopBank)}</td><td>${fmt(r.chamasoft)}</td><td>${fmt(r.cytonn)}</td>
                <td>${fmt(r.totalAssets)}</td><td>${fmt(r.profit)}</td><td>${r.roa ? Number(r.roa).toFixed(1) : '0.0'}</td>
                <td>${formatDisplayDate(r.dateSaved)} <small>${label}</small></td></tr>`;
        });
        html += '</tbody></table>';
    }
    container.innerHTML = html;

    // Load More button logic stays the same
    const btnExists = !!document.getElementById('loadMoreBtn');
    if (currentDisplayCount < history.length) {
        if (!btnExists) {
            const btn = document.createElement('button');
            btn.id = 'loadMoreBtn';
            btn.className = 'btn btn-save';
            btn.textContent = 'LOAD MORE';
            btn.style.margin = '20px auto';
            btn.style.display = 'block';
            btn.onclick = () => {
                renderHistoryLazy();
                if (prevCount < container.children.length) {
                    container.children[prevCount].scrollIntoView({ behavior: 'smooth' });
                }
            };
            container.appendChild(btn);
        }
    } else if (btnExists) {
        document.getElementById('loadMoreBtn').remove();
    }
}

// ==================== AUTO-CREATE NEW MONTH ====================
function autoCreateNewMonthIfNeeded() {
    const currentPeriod = getCurrentPeriod();
    if(window.saccoHistory[currentPeriod]) return;

    const periods = Object.keys(window.saccoHistory).sort().reverse();
    const latestPeriod = periods[0];
    if(!latestPeriod) return;

    const previousRecord = window.saccoHistory[latestPeriod];
    if(!previousRecord || previousRecord.saveType!=='db') return;

    const newRecord = {...previousRecord, period:currentPeriod, dateSaved:new Date().toISOString(), saveType:'live'};
    window.saccoHistory[currentPeriod] = newRecord;
    localStorage.setItem(CACHE_KEY, JSON.stringify(window.saccoHistory));
    renderFullHistory();
    updateSyncStatus(newRecord,false);

    if(autoSaveEnabled) setTimeout(()=>saveCurrentMonth(true),3000);
}

// ==================== SYNC WITH DATABASE ====================
async function syncWithDB() {
    try {
        const res = await fetch(`${API_BASE}/history?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw 1;
        const data = await res.json();
        let changed = false;
        data.forEach(row=>{
            const rec = {
                period: row.period,
                members: Number(row.members||0),
                contributions: Number(row.contributions||0),
                loansDisbursed: Number(row.loans_disbursed||0),
                loansBalance: Number(row.loans_balance||0),
                totalBankBalance: Number(row.total_bank_balance||0),
                coopBank: Number(row.coop_bank||0),
                chamasoft: Number(row.chama_soft||0),
                cytonn: Number(row.cytonn||0),
                totalAssets: Number(row.total_assets||0),
                profit: Number(row.profit),
                roa: Number(row.roa||0),
                dateSaved: row.date_saved||row.dateSaved||new Date().toISOString(),
                saveType:'db'
            };
            if(!window.saccoHistory[rec.period] || rec.dateSaved>(window.saccoHistory[rec.period].dateSaved||'')) {
                window.saccoHistory[rec.period] = rec;
                changed = true;
            }
        });
        if(changed){ 
            localStorage.setItem(CACHE_KEY, JSON.stringify(window.saccoHistory)); 
            renderFullHistory(); 
            showLiveData(); 
        }
    } catch(e) {
        setTimeout(syncWithDB,20000);
    }
}

// ==================== SAVE CURRENT MONTH (100% FIXED) ====================
window.saveCurrentMonth = async function(isAutoSave=false) {
    if(!window.saccoData?.today) { 
        if(!isAutoSave) alert("No data! Visit homepage first."); 
        return; 
    }

    const t = window.saccoData.today;
    const ef = t.extraFields || {};
    const bb = ef.bankBreakdown || [];
    const period = getCurrentPeriod();

    const payload = {
        period,
        members: t.members||0,
        contributions: t.contributions||0,
        loans_disbursed: t.loansDisbursed||t.loans||0,
        loans_balance: t.loansBalance||0,
        total_bank_balance: t.totalBankBalance||t.bankBalance||0,
        coop_bank: bb.find(b=>b.name?.includes('Co-operative'))?.value||0,
        chama_soft: bb.find(b=>b.name?.includes('Chamasoft'))?.value||0,
        cytonn: bb.find(b=>b.name?.includes('Cytonn'))?.value||0,
        total_assets: ef.bookValue||0,
        profit: t.profit||0,
        roa: parseFloat(t.roa)||0,
        extra_fields: ef
    };

    // THIS WAS THE CRASHING LINE — NOW SAFE FOREVER
    window.saccoHistory = window.saccoHistory || {};
    const optimisticRecord = {...payload, dateSaved:new Date().toISOString(), saveType:'db'};
    // Save the official DB version with a suffix so it doesn't overwrite LIVE
window.saccoHistory[period + '_db'] = {
    ...payload,
    dateSaved: new Date().toISOString(),
    saveType: 'db'
};

// Keep the current LIVE version visible
// (it stays at window.saccoHistory[period] until next month)

    localStorage.setItem(CACHE_KEY, JSON.stringify(window.saccoHistory));
    renderFullHistory();
    updateSyncStatus(optimisticRecord,true);

    try {
        const res = await fetch(`${API_BASE}/history/save`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(payload),
            signal: AbortSignal.timeout(10000)
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        retryCount=0;
        if(!isAutoSave) alert("SAVED! All phones in sync");
    } catch(err) {
        console.warn('Save failed:',err.message);
        retryCount++;
        if(retryCount<=MAX_RETRIES) {
            const delay=Math.min(5000*retryCount,30000);
            setTimeout(()=>saveCurrentMonth(true),delay);
            document.getElementById('historyFooter').innerHTML=`<strong style="color:#F59E0B;">OFFLINE • Retrying in ${Math.round(delay/1000)}s</strong>`;
        } else {
            document.getElementById('historyFooter').innerHTML=`<strong style="color:#EF4444;">OFFLINE • Data saved locally</strong>`;
        }
        showLiveData();
    }
};

// ==================== SYNC STATUS ====================
function updateSyncStatus(record,isSynced) {
    const footer = document.getElementById('historyFooter');
    const saveBtn = document.querySelector('.btn-save');
    const container = document.querySelector('.history-section');
    if(!isSynced) {
        if(retryCount>0) footer.innerHTML=`<strong style="color:#F59E0B;">OFFLINE • Retrying (${retryCount}/${MAX_RETRIES})</strong>`;
        else footer.innerHTML=`<strong style="color:#EF4444;">UNSAVED CHANGES • Saving...</strong>`;
        saveBtn.innerHTML = 'SAVING...';
        saveBtn.style.background = '#EF4444';
        container.style.border = '3px solid #EF4444';
        container.style.boxShadow = '0 0 30px rgba(239,68,68,0.4)';
    } else {
        footer.innerHTML=`<strong style="color:#10B981">FULLY SYNCED • All phones updated</strong>`;
        saveBtn.innerHTML='SYNCED';
        saveBtn.style.background='#10B981';
        container.style.border='2px solid #86efac';
        container.style.boxShadow='0 15px 40px rgba(0,0,0,0.08)';
        retryCount=0;
        clearTimeout(autoSyncTimeout);
    }
}

// ==================== LIVE DATA & AUTO-SAVE ====================
function showLiveData() {
    if (!window.saccoData?.today) { setTimeout(showLiveData, 500); return; }

    const t = window.saccoData.today;
    const ef = t.extraFields || {};
    const bb = ef.bankBreakdown || [];
    const period = getCurrentPeriod();

    // THIS IS THE ONLY PART THAT WAS BROKEN — NOW 100% ACCURATE
    const liveData = {
        members:        Number(t.members || t.totalMembers || 0),
        contributions:  Number(t.contributions || t.savings || t.totalSavings || t.totalContributions || 0),

        loansDisbursed: Number(t.loansDisbursed || t.loansIssued || t.totalLoansDisbursed || t.loans || t.totalLoans || 0),
        loansBalance:   Number(t.loansBalance || t.outstandingLoans || t.loanBalance || t.loansOutstanding || 0),

        totalBankBalance: Number(t.totalBankBalance || t.bankBalance || t.totalBank || t.bankTotal || 0),

        coopBank:   Number(bb.find(b => /co-?op|cooperative/i.test(b.name || ''))?.value || 0),
        chamasoft:  Number(bb.find(b => /chamasoft/i.test(b.name || ''))?.value || 0),
        cytonn:     Number(bb.find(b => /cytonn/i.test(b.name || ''))?.value || 0),

        totalAssets: Number(ef.bookValue || ef.totalAssets || ef.book_value || ef.assets || ef.netAssets || 0),
        profit:      Number(t.profit || t.netProfit || t.monthlyProfit || 0),
        roa:         Number(t.roa || t.ROA || t.returnOnAssets || 0)
    };

    window.saccoHistory = window.saccoHistory || {};

    // ALWAYS create/refresh the LIVE entry for current month
    const liveRecord = {
        ...liveData,
        period,
        dateSaved: new Date().toISOString(),
        saveType: 'live'
    };

    // Only update if live data actually changed
    const existingLive = window.saccoHistory[period];
    const liveChanged = !existingLive || 
                        existingLive.saveType !== 'live' || 
                        JSON.stringify(existingLive) !== JSON.stringify(liveRecord);

    if (liveChanged) {
        window.saccoHistory[period] = liveRecord;
        localStorage.setItem(CACHE_KEY, JSON.stringify(window.saccoHistory));
    }

    // Auto-save trigger (only if LIVE differs from DB version)
    const dbRecord = window.saccoHistory[period + '_db']; // we will store DB version with suffix
    const needsAutoSave = autoSaveEnabled && recordsDiffer(liveData, dbRecord || {});

    if (needsAutoSave && liveChanged) {
        clearTimeout(autoSyncTimeout);
        autoSyncTimeout = setTimeout(() => saveCurrentMonth(true), 2000);
    }

    renderFullHistory();
    updateSyncStatus(liveRecord, false); // current month LIVE is never "synced" until saved
    autoCreateNewMonthIfNeeded();
}


// ==================== SILENT WATCHER ====================
function startSilentWatcher(){
    if(silentWatcherActive) return;
    silentWatcherActive=true;
    setInterval(()=>{
        const footer = document.getElementById('historyFooter');
        const saveBtn = document.querySelector('.btn-save');
        if(!footer || !saveBtn) return;
        const isRed = saveBtn.style.backgroundColor==='rgb(239, 68, 68)' || footer.innerHTML.includes('UNSAVED CHANGES');
        const isSaving = footer.innerHTML.includes('Saving...') || footer.innerHTML.includes('Retrying');
        if(isRed && !isSaving) saveCurrentMonth(false);
    },8000);
}

// ==================== AUTO-SAVE TOGGLE ====================
window.toggleAutoSave = function() {
    autoSaveEnabled = !autoSaveEnabled;
    localStorage.setItem('autoSaveEnabled', autoSaveEnabled);
    const text = document.getElementById('autoSaveText');
    text.textContent = autoSaveEnabled ? 'AUTO-SAVE ON':'AUTO-SAVE OFF';
    document.getElementById('autoSaveToggle').style.background = autoSaveEnabled ? '#10B981':'#f59e0b';
};

// ==================== DOWNLOAD CSV ====================
function downloadHistoryCSV() {
    const history = Object.keys(window.saccoHistory)
        .map(key => {
            const record = window.saccoHistory[key];
            const isDb = key.endsWith('_db');
            if (isDb && key.slice(0, -3) !== getCurrentPeriod()) return null;
            return {
                ...record,
                period: isDb ? key.slice(0, -3) : key,
                saveType: isDb ? 'db' : 'live'
            };
        })
        .filter(Boolean)
        .sort((a, b) => {
            if (a.period !== b.period) return b.period.localeCompare(a.period);
            return a.saveType === 'live' ? -1 : 1;
        });

    if (history.length === 0) {
        alert("No history available to download yet.");
        return;
    }
    const csv = convertHistoryToCSV(history);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `soyosoyo_sacco_history_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ==================== EMAIL AUTOMATION ====================
window.sendMonthlyEmail = async function() {
    const record = window.saccoData?.today;
    if (!record) {
        console.warn("Live SACCO data not ready yet.");
        alert("Live data not ready yet.");
        return;
    }

    const period = new Date().toLocaleString('en-KE', { month: 'long', year: 'numeric' });

    const history = Object.values(window.saccoHistory).sort((a,b) => b.period.localeCompare(a.period));
    const csvAttachment = convertHistoryToCSV(history);

    const bodyHTML = `
<h2>Soyosoyo SACCO — Monthly Update (${period})</h2>
<p>Dear Members,</p>
<p>Here is the summary of our SACCO performance for <strong>${period}</strong>:</p>
<ul>
<li><strong>Members:</strong> ${record.members.toLocaleString()}</li>
<li><strong>Total Savings:</strong> KES ${record.contributions.toLocaleString()}</li>
<li><strong>Loans Disbursed:</strong> KES ${record.loansDisbursed.toLocaleString()}</li>
<li><strong>Loans Balance:</strong> KES ${record.loansBalance.toLocaleString()}</li>
<li><strong>Total Bank Balance:</strong> KES ${record.totalBankBalance.toLocaleString()}</li>
<li><strong>Total Assets:</strong> KES ${(record.extraFields?.bookValue || 0).toLocaleString()}</li>
<li><strong>Profit:</strong> KES ${record.profit.toLocaleString()}</li>
<li><strong>ROA:</strong> ${record.roa}%</li>
</ul>
<p>Attached is the full historical data.</p>
<p><em>Soyosoyo SACCO Management</em></p>
`;

    const payload = {
        timestamp: new Date().toISOString(),
        subject: `Soyosoyo SACCO Monthly Update — ${period}`,
        body: bodyHTML,
        attachment: csvAttachment,
        recipients: ["members@soyosoyo.co.ke"]
    };

    try {
        const res = await fetch(`${API_BASE}/zapier`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            console.log("Monthly email sent successfully!");
            alert("Monthly email sent successfully!");
        } else {
            const result = await res.json();
            console.warn("Zapier returned an error:", result);
            alert("Zapier returned an error. Check console.");
        }
    } catch (err) {
        console.error("Error sending monthly email:", err);
        alert("Error sending email. Check console.");
    }
};

// ==================== SCHEDULE MONTHLY EMAIL ====================
function scheduleMonthlyEmail() {
    const now = new Date();
    const nextMonth = new Date(now.getFullYear(), now.getMonth()+1,1,9,0,0);
    const delay = nextMonth.getTime()-now.getTime();
    setTimeout(()=>{
        window.sendMonthlyEmail();
        scheduleMonthlyEmail();
    },delay);
}

// ==================== INIT ====================
window.addEventListener('DOMContentLoaded',()=>{
    loadCache();
    renderFullHistory();
    syncWithDB();
    showLiveData();
    startSilentWatcher();
    scheduleMonthlyEmail();
});

// Final safety net (in case anything runs before DOMContentLoaded)
window.saccoHistory = window.saccoHistory || {};
</script>

<!-- All your original extra scripts -->
<script>
let lastSavedData = null;

function shouldSave(data) {
  return JSON.stringify(data) !== JSON.stringify(lastSavedData);
}

window.addEventListener('saccoDataUpdated', () => {
  if (shouldSave(window.saccoData)) {
    saveCurrentMonth(true);
    lastSavedData = JSON.parse(JSON.stringify(window.saccoData));
  }
});
</script>

<script src="./scripts/chatbot.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
