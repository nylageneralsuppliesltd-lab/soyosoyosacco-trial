// MONTHLY SAVE + RENDER + DOWNLOAD — EXTRACTS FROM CAROUSEL DIRECTLY
function loadPersistedData() {
    // Load history if available
    const savedHistory = localStorage.getItem('saccoHistory');
    if (savedHistory && !window.saccoHistory) {
        try {
            window.saccoHistory = JSON.parse(savedHistory);
            console.log('Recovered history from localStorage');
        } catch (e) {
            console.error('Corrupted history:', e);
            window.saccoHistory = {};
        }
    }
}

function savePersistedData() {
    if (window.saccoHistory) {
        localStorage.setItem('saccoHistory', JSON.stringify(window.saccoHistory));
    }
}

// NEW: Fetch & Parse Carousel Data from index.html
async function fetchCarouselData() {
    try {
        const response = await fetch('/index.html');  // Same-origin fetch
        if (!response.ok) throw new Error('Failed to fetch index.html');
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Find carousel slides (adjust selector if needed: e.g., '.carousel .slide', '#financialCarousel div')
        const slides = doc.querySelectorAll('.carousel div');  // Assumes <div class="carousel"> with child <div>s as slides
        let todayData = {
            members: null,
            contributions: null,
            loans: null,
            bankBalance: null,
            profit: null,
            roa: null
        };

        // Extract numbers from slide texts (regex for common formats like "Members: 152" or "KSh 28,500")
        slides.forEach(slide => {
            const text = slide.textContent.toLowerCase().trim();
            
            // Members
            if (text.includes('member') || text.includes('members')) {
                const match = text.match(/(\d+(?:,\d+)?)/);
                if (match) todayData.members = parseInt(match[1].replace(/,/g, ''));
            }
            // Contributions (KES optional)
            if (text.includes('contribut') || text.includes('savings')) {
                const match = text.match(/ksh?\s*?(\d+(?:,\d+)?)/i) || text.match(/(\d+(?:,\d+)?)/);
                if (match) todayData.contributions = parseInt(match[1].replace(/,/g, ''));
            }
            // Loans
            if (text.includes('loan') || text.includes('disbursed')) {
                const match = text.match(/ksh?\s*?(\d+(?:,\d+)?)/i) || text.match(/(\d+(?:,\d+)?)/);
                if (match) todayData.loans = parseInt(match[1].replace(/,/g, ''));
            }
            // Bank Balance
            if (text.includes('balance') || text.includes('assets')) {
                const match = text.match(/ksh?\s*?(\d+(?:,\d+)?)/i) || text.match(/(\d+(?:,\d+)?)/);
                if (match) todayData.bankBalance = parseInt(match[1].replace(/,/g, ''));
            }
            // Profit
            if (text.includes('profit') || text.includes('dividends')) {
                const match = text.match(/ksh?\s*?(\d+(?:,\d+)?)/i) || text.match(/(\d+(?:,\d+)?)/);
                if (match) todayData.profit = parseInt(match[1].replace(/,/g, ''));
            }
            // ROA (percent)
            if (text.includes('roa') || text.includes('return')) {
                const match = text.match(/(\d+(?:\.\d+)?)\s*%?/);
                if (match) todayData.roa = parseFloat(match[1]);
            }
        });

        // Validate: Need at least members & contributions
        const validKeys = Object.keys(todayData).filter(k => todayData[k] !== null);
        if (validKeys.length < 2) {
            throw new Error('Insufficient data extracted from carousel. Check slide texts.');
        }

        console.log('Extracted carousel data:', todayData);
        return todayData;
    } catch (error) {
        console.error('Carousel fetch/parse failed:', error);
        alert('Could not load current data from Financial Highlights. Ensure index.html has the carousel populated.');
        return null;
    }
}

function saveCurrentMonth() {
    loadPersistedData();  // For history

    let today = window.saccoData?.today;  // Fallback to global if set

    // If no global, extract from carousel
    if (!today) {
        today = await fetchCarouselData();
        if (!today) return;
    }

    // Validate key fields
    if (isNaN(today.members) || isNaN(today.contributions)) {
        alert("Invalid data format. Check carousel slides for numbers.");
        return;
    }

    if (!window.saccoHistory) window.saccoHistory = {};
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const key = `${year}-${month}`;

    // Skip duplicate (optional)
    // if (window.saccoHistory[key]) { alert(`Already saved for ${key}`); return; }

    window.saccoHistory[key] = {
        period: key,
        members: today.members,
        contributions: today.contributions,
        loans: today.loans || 0,
        bankBalance: today.bankBalance || 0,
        profit: today.profit || 0,
        roa: today.roa || 0,
        dateSaved: date.toISOString().split('T')[0]
    };

    savePersistedData();
    renderFullHistory();
    alert(`MONTHLY DATA ${key} SAVED! (Members: ${today.members.toLocaleString()})`);
    console.log("Saved:", window.saccoHistory[key]);
}

function renderFullHistory() {
    loadPersistedData();
    const tableContainer = document.getElementById('fullHistoryTable');
    const footer = document.getElementById('historyFooter');
    if (!tableContainer) return;

    if (!window.saccoHistory || Object.keys(window.saccoHistory).length === 0) {
        tableContainer.innerHTML = `<p style="text-align:center; color:#6b7280; padding:40px;">No monthly data saved yet. Click SAVE to pull from Financial Highlights!</p>`;
        footer.textContent = "Data sourced live from homepage carousel.";
        return;
    }

    const periods = Object.keys(window.saccoHistory).sort().reverse();
    const currentMonth = new Date().toISOString().slice(0,7);

    tableContainer.innerHTML = `
        <table>
            <thead><tr><th>Period</th><th>Members</th><th>Contributions</th><th>Loans</th><th>Bank Balance</th><th>ROA %</th><th>Saved On</th></tr></thead>
            <tbody>
                ${periods.map(key => {
                    const d = window.saccoHistory[key];
                    const isCurrent = key === currentMonth;
                    return `
                        <tr ${isCurrent ? 'class="current-month"' : ''}>
                            <td style="font-weight:900; color:#004d1a;">${d.period || key}</td>
                            <td>${d.members?.toLocaleString() || '—'}</td>
                            <td>KSh ${d.contributions?.toLocaleString() || '—'}</td>
                            <td>KSh ${d.loans?.toLocaleString() || '—'}</td>
                            <td>KSh ${d.bankBalance?.toLocaleString() || '—'}</td>
                            <td style="color:#10B981; font-weight:bold;">${d.roa || '—'}%</td>
                            <td>${d.dateSaved || '—'}</td>
                        </tr>
                    `;
                }).join('')}
            </tbody>
        </table>
    `;

    const totalSize = (JSON.stringify(window.saccoHistory).length / 1024).toFixed(1);
    footer.innerHTML = `
        Total Records: <strong>${periods.length}</strong> | Latest: <strong>${periods[0]}</strong> | 
        <span style="color:#10B981;">~${totalSize} KB</span> | 
        <button onclick="clearAllData()" style="background:none; border:none; color:#ef4444; cursor:pointer; font-weight:bold;">Clear</button>
    `;
}

function downloadHistoryCSV() {
    loadPersistedData();
    if (!window.saccoHistory || Object.keys(window.saccoHistory).length === 0) {
        alert("No data yet.");
        return;
    }
    const periods = Object.keys(window.saccoHistory).sort();
    let csv = "Period,Members,Contributions (KSh),Loans (KSh),Bank Balance (KSh),ROA %,Date Saved\n";
    periods.forEach(key => {
        const d = window.saccoHistory[key];
        csv += `"${d.period || key}",${d.members || ''},"${d.contributions || ''}","${d.loans || ''}","${d.bankBalance || ''}",${d.roa || ''},"${d.dateSaved || ''}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SOYOSOYO_MONTHLY_${new Date().getFullYear()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
}

function clearAllData() {
    if (confirm('Clear all?')) {
        localStorage.removeItem('saccoHistory');
        window.saccoHistory = {};
        renderFullHistory();
        alert('Cleared.');
    }
}

// AUTO-RENDER
document.addEventListener('DOMContentLoaded', () => {
    loadPersistedData();
    renderFullHistory();
});
setTimeout(renderFullHistory, 1000);
